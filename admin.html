<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="لوحة تحكم المشرفين - مدرسة النصر الاعدادية المشتركة ك15">
    <title>لوحة تحكم المشرفين | مدرسة النصر الاعدادية المشتركة ك15</title>
    <!-- Preconnect to Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Load Cairo font with display=swap for better text visibility during loading -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap&text=ابتثجحخدذرزسشصضطظعغفقكلمنهويءؤةئ٠١٢٣٤٥٦٧٨٩&subset=arabic" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        /* Admin Panel Styles */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Make sure admin dashboard is always visible */
        #admin-dashboard {
            display: block;
        }
        
        /* Hide navigation in admin panel */
        .admin-page .main-nav,
        .admin-page .menu-toggle {
            display: none;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .admin-title {
            font-size: 1.8rem;
            color: #0056b3;
            margin: 0;
        }
        
        .admin-actions {
            display: flex;
            gap: 10px;
        }
        
        .admin-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .admin-card-title {
            font-size: 1.4rem;
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        /* News Management Styles */
        .news-form {
            display: none;
        }
        
        .news-list {
            margin-top: 20px;
        }
        
        .news-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }
        
        .news-item:hover {
            background-color: #f9f9f9;
        }
        
        .news-item-title {
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .news-item-date {
            color: #666;
            font-size: 0.9rem;
            margin: 5px 0 0;
        }
        
        .news-item-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 10px;
            color: white;
        }
        
        .category-academic {
            background-color: #4caf50;
        }
        
        .category-activities {
            background-color: #2196f3;
        }
        
        .category-events {
            background-color: #ff9800;
        }
        
        .category-announcements {
            background-color: #9c27b0;
        }
        
        .news-item-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: #0056b3;
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.3s;
            padding: 5px;
        }
        
        .btn-icon:hover {
            color: #003d7a;
        }
        
        .btn-delete {
            color: #e53935;
        }
        
        .btn-delete:hover {
            color: #c62828;
        }
        
        /* Rich Text Editor */
        .editor-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .editor-btn {
            background: none;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        
        .editor-btn:hover {
            background-color: #e0e0e0;
        }
        
        .editor-content {
            padding: 15px;
            min-height: 200px;
            outline: none;
        }
        
        /* Image Upload */
        .image-preview {
            max-width: 100%;
            height: 200px;
            margin-top: 10px;
            border: 1px dashed #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .upload-progress {
            margin-top: 10px;
            height: 5px;
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            width: 0;
            background-color: #0056b3;
            transition: width 0.3s;
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 86, 179, 0.3);
            border-radius: 50%;
            border-top-color: #0056b3;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .admin-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .news-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .news-item-actions {
                margin-top: 15px;
                align-self: flex-end;
            }
        }
        
        /* Dashboard Styles */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            color: #0056b3;
            margin-bottom: 10px;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        /* Tabs */
        .admin-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .admin-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .admin-tab.active {
            border-bottom-color: #0056b3;
            color: #0056b3;
        }
        
        .admin-tab:hover:not(.active) {
            background-color: #f5f5f5;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .alert-error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .alert-close {
            float: left;
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body class="admin-page">
    <!-- Fallback for users with JavaScript disabled -->
    <noscript>
        <div style="background-color: #f44336; color: white; text-align: center; padding: 10px; direction: rtl;">
            يرجى تفعيل جافا سكريبت للحصول على أفضل تجربة لموقعنا
        </div>
    </noscript>
    
    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <div class="logo">
                <h1>مدرسة النصر الاعدادية المشتركة ك15</h1>
            </div>
            <nav class="main-nav" aria-label="القائمة الرئيسية">
                <button class="close-menu-btn" aria-label="إغلاق القائمة"><i class="fas fa-times"></i></button>
                <ul>
                    <li><a href="index.html">الرئيسية</a></li>
                    <li><a href="about.html">عن المدرسة</a></li>
                    <li><a href="news.html">الأخبار</a></li>
                    <li><a href="contact.html">اتصل بنا</a></li>
                </ul>
            </nav>
            <button class="menu-toggle" aria-label="فتح القائمة" aria-expanded="false">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Page Banner -->
    <section class="page-banner">
        <div class="page-banner-overlay"></div>
        <div class="container">
            <h2>لوحة تحكم المشرفين</h2>
            <nav class="breadcrumb">
                <a href="index.html">الرئيسية</a> / <span>لوحة التحكم</span>
            </nav>
        </div>
    </section>

    <!-- Admin Dashboard -->
    <section id="admin-dashboard" class="admin-section">
        <div class="admin-container">
            <!-- Alert Messages -->
            <div class="alert alert-success" id="alert-success">
                <span class="alert-close">&times;</span>
                <span id="success-message"></span>
            </div>
            <div class="alert alert-error" id="alert-error">
                <span class="alert-close">&times;</span>
                <span id="error-message"></span>
            </div>
            
            <!-- Admin Header -->
            <div class="admin-header">
                <h2 class="admin-title">لوحة تحكم المشرفين</h2>
                <div class="admin-actions">
                    <button id="add-news-btn" class="btn btn-primary">
                        <i class="material-icons">add</i> إضافة خبر جديد
                    </button>
                    <button id="logout-btn" class="btn btn-secondary">
                        <i class="material-icons">logout</i> تسجيل الخروج
                    </button>
                </div>
            </div>
            
            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="material-icons">article</i>
                    </div>
                    <h3 class="stat-number" id="total-news">0</h3>
                    <p class="stat-label">إجمالي الأخبار</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="material-icons">school</i>
                    </div>
                    <h3 class="stat-number" id="academic-news">0</h3>
                    <p class="stat-label">أخبار أكاديمية</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="material-icons">event</i>
                    </div>
                    <h3 class="stat-number" id="events-news">0</h3>
                    <p class="stat-label">فعاليات</p>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="material-icons">campaign</i>
                    </div>
                    <h3 class="stat-number" id="announcements-news">0</h3>
                    <p class="stat-label">إعلانات</p>
                </div>
            </div>
            
            <!-- Admin Tabs -->
            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="news-list-tab">قائمة الأخبار</div>
                <div class="admin-tab" data-tab="add-news-tab">إضافة خبر</div>
            </div>
            
            <!-- News List Tab -->
            <div class="tab-content active" id="news-list-tab">
                <div class="admin-card">
                    <h3 class="admin-card-title">قائمة الأخبار</h3>
                    
                    <div class="news-list" id="news-list">
                        <!-- News items will be loaded here dynamically -->
                        <div class="text-center" id="news-loading">
                            <div class="spinner"></div> جاري تحميل الأخبار...
                        </div>
                        <div id="no-news-message" style="display: none; text-align: center; padding: 20px;">
                            لا توجد أخبار حالياً. قم بإضافة خبر جديد.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add News Tab -->
            <div class="tab-content" id="add-news-tab">
                <div class="admin-card">
                    <h3 class="admin-card-title" id="form-title">إضافة خبر جديد</h3>
                    
                    <form id="news-form">
                        <input type="hidden" id="news-id">
                        <div class="form-group">
                            <label for="news-title" class="form-label">عنوان الخبر</label>
                            <input type="text" id="news-title" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="news-category" class="form-label">تصنيف الخبر</label>
                            <select id="news-category" class="form-control" required>
                                <option value="">اختر التصنيف</option>
                                <option value="academic">أكاديمي</option>
                                <option value="activities">أنشطة</option>
                                <option value="events">فعاليات</option>
                                <option value="announcements">إعلانات</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="news-date" class="form-label">تاريخ الخبر</label>
                            <input type="date" id="news-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="news-excerpt" class="form-label">ملخص الخبر</label>
                            <textarea id="news-excerpt" class="form-control" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="news-content" class="form-label">محتوى الخبر</label>
                            <div class="editor-container">
                                <div class="editor-toolbar">
                                    <button type="button" class="editor-btn" data-command="bold" title="غامق">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button type="button" class="editor-btn" data-command="italic" title="مائل">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button type="button" class="editor-btn" data-command="underline" title="تحته خط">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                    <button type="button" class="editor-btn" data-command="insertUnorderedList" title="قائمة نقطية">
                                        <i class="fas fa-list-ul"></i>
                                    </button>
                                    <button type="button" class="editor-btn" data-command="insertOrderedList" title="قائمة رقمية">
                                        <i class="fas fa-list-ol"></i>
                                    </button>
                                    <button type="button" class="editor-btn" data-command="createLink" title="رابط">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button type="button" class="editor-btn" data-command="unlink" title="إزالة الرابط">
                                        <i class="fas fa-unlink"></i>
                                    </button>
                                </div>
                                <div class="editor-content" id="news-content" contenteditable="true"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="news-image-url" class="form-label">رابط صورة الخبر</label>
                            <input type="url" id="news-image-url" class="form-control" placeholder="أدخل رابط الصورة هنا">
                            <small class="form-text">يمكنك إضافة رابط الصورة مباشرة بدلاً من رفع ملف</small>
                        </div>
                        <div class="form-group">
                            <label for="news-image" class="form-label">صورة الخبر (اختياري)</label>
                            <input type="file" id="news-image" class="form-control" accept="image/*">
                            <div class="image-preview" id="image-preview">
                                <span id="image-placeholder">لم يتم اختيار صورة</span>
                                <img id="preview-img" style="display: none;">
                            </div>
                            <div class="upload-progress" id="upload-progress">
                                <div class="progress-bar" id="progress-bar"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" id="save-news-btn">
                                <i class="material-icons">save</i> حفظ الخبر
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancel-btn">
                                <i class="material-icons">cancel</i> إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-about">
                    <h3>مدرسة النصر الاعدادية</h3>
                    <p>مؤسسة تعليمية رائدة تسعى لتقديم تعليم متميز وبناء جيل واعٍ قادر على مواجهة تحديات المستقبل.</p>
                    <div class="social-links">
                        <a href="https://www.facebook.com/AlNassrSchool" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="https://twitter.com/AlNassrSchool" target="_blank" rel="noopener noreferrer" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.instagram.com/alnassrschool" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://www.youtube.com/c/AlNassrSchool" target="_blank" rel="noopener noreferrer" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="footer-links">
                    <h3>روابط سريعة</h3>
                    <ul>
                        <li><a href="index.html">الرئيسية</a></li>
                        <li><a href="about.html">عن المدرسة</a></li>
                        <li><a href="news.html">الأخبار</a></li>
                        <li><a href="contact.html">اتصل بنا</a></li>
                    </ul>
                </div>
                <div class="footer-contact">
                    <h3>اتصل بنا</h3>
                    <ul>
                        <li><i class="fas fa-map-marker-alt"></i> القنطرة، محافظة الإسماعيلية</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 مدرسة النصر الاعدادية المشتركة ك15. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <script src="scripts/main.js"></script>
    
    <!-- Firebase Scripts -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            addDoc, 
            deleteDoc,
            updateDoc,
            doc, 
            getDoc,
            query, 
            where, 
            orderBy,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytesResumable, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUX53v4qLzn4Mz91HkfyE6rWwIqNza4Ak",
            authDomain: "al-nassr-school.firebaseapp.com",
            projectId: "al-nassr-school",
            storageBucket: "al-nassr-school.firebasestorage.app",
            messagingSenderId: "404145960502",
            appId: "1:404145960502:web:2f1462d592a8cff3858a97",
            measurementId: "G-MM97PYYM2H"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements
        const adminDashboard = document.getElementById('admin-dashboard');
        const logoutBtn = document.getElementById('logout-btn');

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page loaded, initializing...");
            // Always show the admin dashboard
            adminDashboard.style.display = 'block';
            
            // Initialize tabs
            initTabs();
            
            // Initialize buttons
            initButtons();
            
            // Load news from Firestore
            loadNews();
        });

        // Initialize tabs functionality
        function initTabs() {
            const tabs = document.querySelectorAll('.admin-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        // Initialize buttons functionality
        function initButtons() {
            const addNewsBtn = document.getElementById('add-news-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const newsForm = document.getElementById('news-form');
            const alertSuccess = document.getElementById('alert-success');
            const alertError = document.getElementById('alert-error');
            const alertCloseButtons = document.querySelectorAll('.alert-close');
            
            // Add News button - Switch to Add News tab
            if (addNewsBtn) {
                addNewsBtn.addEventListener('click', () => {
                    // Switch to Add News tab
                    const tabs = document.querySelectorAll('.admin-tab');
                    const tabContents = document.querySelectorAll('.tab-content');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    document.querySelector('[data-tab="add-news-tab"]').classList.add('active');
                    document.getElementById('add-news-tab').classList.add('active');
                    
                    // Reset form
                    resetNewsForm();
                });
            }
            
            // Cancel button - Switch back to News List tab
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    // Switch to News List tab
                    const tabs = document.querySelectorAll('.admin-tab');
                    const tabContents = document.querySelectorAll('.tab-content');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    document.querySelector('[data-tab="news-list-tab"]').classList.add('active');
                    document.getElementById('news-list-tab').classList.add('active');
                });
            }
            
            // News Form submission
            if (newsForm) {
                newsForm.addEventListener('submit', handleNewsFormSubmit);
            }
            
            // Close alert messages
            alertCloseButtons.forEach(button => {
                button.addEventListener('click', function() {
                    this.parentElement.style.display = 'none';
                });
            });
            
            // Image preview functionality
            const newsImage = document.getElementById('news-image');
            const previewImg = document.getElementById('preview-img');
            const imagePlaceholder = document.getElementById('image-placeholder');
            
            if (newsImage && previewImg && imagePlaceholder) {
                newsImage.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            previewImg.style.display = 'block';
                            imagePlaceholder.style.display = 'none';
                        };
                        
                        reader.readAsDataURL(file);
                    } else {
                        previewImg.style.display = 'none';
                        imagePlaceholder.style.display = 'block';
                    }
                });
            }
            
            // Image URL preview functionality
            const newsImageUrl = document.getElementById('news-image-url');
            if (newsImageUrl && previewImg && imagePlaceholder) {
                newsImageUrl.addEventListener('input', function() {
                    const url = this.value.trim();
                    if (url) {
                        previewImg.src = url;
                        previewImg.style.display = 'block';
                        imagePlaceholder.style.display = 'none';
                        
                        // Clear file input when URL is provided
                        if (newsImage) {
                            newsImage.value = '';
                        }
                        
                        // Handle image load error
                        previewImg.onerror = function() {
                            previewImg.style.display = 'none';
                            imagePlaceholder.style.display = 'block';
                            imagePlaceholder.textContent = 'رابط الصورة غير صالح';
                        };
                        
                        // Reset error message when image loads successfully
                        previewImg.onload = function() {
                            imagePlaceholder.textContent = 'لم يتم اختيار صورة';
                        };
                    } else {
                        previewImg.style.display = 'none';
                        imagePlaceholder.style.display = 'block';
                    }
                });
            }
            
            // Rich text editor buttons
            const editorButtons = document.querySelectorAll('.editor-btn');
            const editorContent = document.getElementById('news-content');
            
            if (editorButtons.length > 0 && editorContent) {
                editorButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const command = this.getAttribute('data-command');
                        
                        if (command === 'createLink') {
                            const url = prompt('أدخل الرابط:');
                            if (url) document.execCommand(command, false, url);
                        } else {
                            document.execCommand(command, false, null);
                        }
                        
                        editorContent.focus();
                    });
                });
            }
        }

        // Logout Button
        logoutBtn.addEventListener('click', () => {
            console.log("Logout button clicked");
            window.location.href = 'index.html';
        });
        
        // Handle news form submission
        async function handleNewsFormSubmit(e) {
            e.preventDefault();
            
            try {
                // Get form values
                const newsId = document.getElementById('news-id').value;
                const title = document.getElementById('news-title').value;
                const category = document.getElementById('news-category').value;
                const date = document.getElementById('news-date').value;
                const excerpt = document.getElementById('news-excerpt').value;
                const content = document.getElementById('news-content').innerHTML;
                const imageFile = document.getElementById('news-image').files[0];
                const imageUrl = document.getElementById('news-image-url').value.trim();
                
                // Validate form
                if (!title || !category || !date || !excerpt || !content) {
                    showError('يرجى ملء جميع الحقول المطلوبة');
                    return;
                }
                
                // Show loading state
                const saveBtn = document.getElementById('save-news-btn');
                const originalBtnText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<div class="spinner"></div> جاري الحفظ...';
                saveBtn.disabled = true;
                
                // Get image URL (either from file upload or direct URL input)
                let finalImageUrl = '';
                
                // If image URL is provided, use it directly
                if (imageUrl) {
                    finalImageUrl = imageUrl;
                } 
                // Otherwise, upload the file if selected
                else if (imageFile) {
                    // Show upload progress
                    const uploadProgress = document.getElementById('upload-progress');
                    const progressBar = document.getElementById('progress-bar');
                    uploadProgress.style.display = 'block';
                    
                    // Upload to Firebase Storage
                    finalImageUrl = await uploadImage(imageFile, (progress) => {
                        progressBar.style.width = `${progress}%`;
                    });
                    
                    // Hide progress after upload
                    uploadProgress.style.display = 'none';
                }
                
                // Prepare news data
                const newsData = {
                    title,
                    category,
                    date,
                    excerpt,
                    content,
                    imageUrl: finalImageUrl,
                    createdAt: serverTimestamp()
                };
                
                // Save to Firestore
                const docRef = await addDoc(collection(db, "news"), newsData);
                
                // Show success message
                showSuccess('تم حفظ الخبر بنجاح');
                
                // Reset form
                resetNewsForm();
                
                // Switch to News List tab
                const tabs = document.querySelectorAll('.admin-tab');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                document.querySelector('[data-tab="news-list-tab"]').classList.add('active');
                document.getElementById('news-list-tab').classList.add('active');
                
                // Reload news list
                loadNews();
                
            } catch (error) {
                console.error("Error adding news: ", error);
                showError('حدث خطأ أثناء حفظ الخبر. يرجى المحاولة مرة أخرى.');
            } finally {
                // Reset button state
                const saveBtn = document.getElementById('save-news-btn');
                saveBtn.innerHTML = '<i class="material-icons">save</i> حفظ الخبر';
                saveBtn.disabled = false;
            }
        }

        // Upload image to Firebase Storage
        async function uploadImage(file, progressCallback) {
            return new Promise((resolve, reject) => {
                try {
                    const storage = getStorage();
                    const storageRef = ref(storage, `news-images/${Date.now()}_${file.name}`);
                    
                    // Create upload task
                    const uploadTask = uploadBytesResumable(storageRef, file);
                    
                    // Register three observers:
                    // 1. 'state_changed' observer, called any time the state changes
                    // 2. Error observer, called on failure
                    // 3. Completion observer, called on successful completion
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            // Observe state change events such as progress, pause, and resume
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log('Upload is ' + progress + '% done');
                            if (progressCallback) progressCallback(progress);
                        }, 
                        (error) => {
                            // Handle unsuccessful uploads
                            console.error("Upload error:", error);
                            reject(error);
                        }, 
                        async () => {
                            // Handle successful uploads on complete
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            console.log('File available at', downloadURL);
                            resolve(downloadURL);
                        }
                    );
                } catch (error) {
                    console.error("Error in uploadImage:", error);
                    reject(error);
                }
            });
        }

        // Load news from Firestore
        async function loadNews() {
            const newsList = document.getElementById('news-list');
            const newsLoading = document.getElementById('news-loading');
            const noNewsMessage = document.getElementById('no-news-message');
            
            try {
                // Show loading
                if (newsLoading) newsLoading.style.display = 'block';
                if (noNewsMessage) noNewsMessage.style.display = 'none';
                
                // Clear existing news items
                if (newsList) {
                    // Keep the loading and no-news elements
                    const loadingEl = document.getElementById('news-loading');
                    const noNewsEl = document.getElementById('no-news-message');
                    newsList.innerHTML = '';
                    if (loadingEl) newsList.appendChild(loadingEl);
                    if (noNewsEl) newsList.appendChild(noNewsEl);
                }
                
                // Get news from Firestore
                const newsQuery = query(collection(db, "news"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(newsQuery);
                
                // Update stats
                let totalNews = 0;
                let academicNews = 0;
                let eventsNews = 0;
                let announcementsNews = 0;
                let activitiesNews = 0;
                
                // Check if we have news
                if (querySnapshot.empty) {
                    if (newsLoading) newsLoading.style.display = 'none';
                    if (noNewsMessage) noNewsMessage.style.display = 'block';
                } else {
                    // Create news items
                    querySnapshot.forEach((doc) => {
                        const newsData = doc.data();
                        const newsId = doc.id;
                        
                        // Update stats
                        totalNews++;
                        if (newsData.category === 'academic') academicNews++;
                        else if (newsData.category === 'events') eventsNews++;
                        else if (newsData.category === 'announcements') announcementsNews++;
                        else if (newsData.category === 'activities') activitiesNews++;
                        
                        // Create news item element
                        const newsItem = document.createElement('div');
                        newsItem.className = 'news-item';
                        newsItem.innerHTML = `
                            <div>
                                <h4 class="news-item-title">${newsData.title}</h4>
                                <p class="news-item-date">
                                    <span class="news-item-category category-${newsData.category}">${getCategoryName(newsData.category)}</span>
                                    ${newsData.date}
                                </p>
                            </div>
                            <div class="news-item-actions">
                                <button class="btn-icon btn-edit" data-id="${newsId}" title="تعديل">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button class="btn-icon btn-delete" data-id="${newsId}" title="حذف">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>
                        `;
                        
                        // Add to news list
                        if (newsList) newsList.insertBefore(newsItem, noNewsMessage);
                        
                        // Add event listeners for edit and delete buttons
                        const editBtn = newsItem.querySelector('.btn-edit');
                        const deleteBtn = newsItem.querySelector('.btn-delete');
                        
                        if (editBtn) {
                            editBtn.addEventListener('click', () => {
                                editNews(newsId);
                            });
                        }
                        
                        if (deleteBtn) {
                            deleteBtn.addEventListener('click', () => {
                                deleteNews(newsId);
                            });
                        }
                    });
                    
                    // Hide loading
                    if (newsLoading) newsLoading.style.display = 'none';
                }
                
                // Update stats display
                document.getElementById('total-news').textContent = totalNews;
                document.getElementById('academic-news').textContent = academicNews;
                document.getElementById('events-news').textContent = eventsNews;
                document.getElementById('announcements-news').textContent = announcementsNews;
                
            } catch (error) {
                console.error("Error loading news: ", error);
                if (newsLoading) newsLoading.style.display = 'none';
                showError('حدث خطأ أثناء تحميل الأخبار. يرجى تحديث الصفحة.');
            }
        }

        // Reset news form
        function resetNewsForm() {
            document.getElementById('news-id').value = '';
            document.getElementById('news-title').value = '';
            document.getElementById('news-category').value = '';
            document.getElementById('news-date').value = '';
            document.getElementById('news-excerpt').value = '';
            document.getElementById('news-content').innerHTML = '';
            document.getElementById('news-image').value = '';
            document.getElementById('news-image-url').value = '';
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('image-placeholder').style.display = 'block';
            document.getElementById('image-placeholder').textContent = 'لم يتم اختيار صورة';
            document.getElementById('form-title').textContent = 'إضافة خبر جديد';
        }

        // Show success message
        function showSuccess(message) {
            const alertSuccess = document.getElementById('alert-success');
            const successMessage = document.getElementById('success-message');
            
            if (alertSuccess && successMessage) {
                successMessage.textContent = message;
                alertSuccess.style.display = 'block';
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    alertSuccess.style.display = 'none';
                }, 5000);
            }
        }

        // Show error message
        function showError(message) {
            const alertError = document.getElementById('alert-error');
            const errorMessage = document.getElementById('error-message');
            
            if (alertError && errorMessage) {
                errorMessage.textContent = message;
                alertError.style.display = 'block';
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    alertError.style.display = 'none';
                }, 5000);
            }
        }

        // Get category name in Arabic
        function getCategoryName(category) {
            const categories = {
                'academic': 'أكاديمي',
                'activities': 'أنشطة',
                'events': 'فعاليات',
                'announcements': 'إعلانات'
            };
            
            return categories[category] || category;
        }

        // Edit news function
        async function editNews(newsId) {
            try {
                // Get news data from Firestore
                const docRef = doc(db, "news", newsId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const newsData = docSnap.data();
                    
                    // Fill form with news data
                    document.getElementById('news-id').value = newsId;
                    document.getElementById('news-title').value = newsData.title;
                    document.getElementById('news-category').value = newsData.category;
                    document.getElementById('news-date').value = newsData.date;
                    document.getElementById('news-excerpt').value = newsData.excerpt;
                    document.getElementById('news-content').innerHTML = newsData.content;
                    
                    // Show image preview if available
                    if (newsData.imageUrl) {
                        document.getElementById('preview-img').src = newsData.imageUrl;
                        document.getElementById('preview-img').style.display = 'block';
                        document.getElementById('image-placeholder').style.display = 'none';
                        document.getElementById('news-image-url').value = newsData.imageUrl;
                    }
                    
                    // Update form title
                    document.getElementById('form-title').textContent = 'تعديل الخبر';
                    
                    // Switch to Add News tab
                    const tabs = document.querySelectorAll('.admin-tab');
                    const tabContents = document.querySelectorAll('.tab-content');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    document.querySelector('[data-tab="add-news-tab"]').classList.add('active');
                    document.getElementById('add-news-tab').classList.add('active');
                } else {
                    showError('الخبر غير موجود');
                }
            } catch (error) {
                console.error("Error editing news: ", error);
                showError('حدث خطأ أثناء تحميل بيانات الخبر');
            }
        }

        // Delete news function
        async function deleteNews(newsId) {
            if (confirm('هل أنت متأكد من حذف هذا الخبر؟')) {
                try {
                    // Delete from Firestore
                    await deleteDoc(doc(db, "news", newsId));
                    
                    // Show success message
                    showSuccess('تم حذف الخبر بنجاح');
                    
                    // Reload news list
                    loadNews();
                } catch (error) {
                    console.error("Error deleting news: ", error);
                    showError('حدث خطأ أثناء حذف الخبر');
                }
            }
        }
    </script>
</body>
</html>